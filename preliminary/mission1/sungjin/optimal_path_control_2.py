import math

WAYPOINTS = [[0.70823, 0.35672, 4.0, 0.0758],
[0.50682, 0.58334, 4.0, 0.0758],
[0.30522, 0.80979, 4.0, 0.0758],
[0.10341, 1.03605, 4.0, 0.0758],
[-0.09859, 1.26214, 4.0, 0.0758],
[-0.30058, 1.48824, 4.0, 0.0758],
[-0.50234, 1.71454, 4.0, 0.0758],
[-0.70389, 1.94103, 3.5145, 0.08627],
[-0.90523, 2.16772, 2.79749, 0.10838],
[-1.10635, 2.3946, 2.39318, 0.12669],
[-1.30725, 2.62167, 2.11986, 0.14302],
[-1.50807, 2.84882, 1.92137, 0.1578],
[-1.7143, 3.06751, 1.7672, 0.1701],
[-1.9313, 3.26589, 1.64289, 0.17896],
[-2.16054, 3.43195, 1.5381, 0.18403],
[-2.39934, 3.55577, 1.5381, 0.17489],
[-2.64196, 3.63052, 1.5381, 0.16506],
[-2.8808, 3.65268, 1.5381, 0.15595],
[-3.10719, 3.621, 1.5381, 0.14862],
[-3.31106, 3.5357, 1.5381, 0.14368],
[-3.47942, 3.39889, 1.61704, 0.13416],
[-3.60711, 3.22477, 1.7037, 0.12674],
[-3.692, 3.02554, 1.80261, 0.12014],
[-3.73452, 2.81193, 1.91982, 0.11345],
[-3.73754, 2.59306, 2.06283, 0.10611],
[-3.70583, 2.37596, 2.24228, 0.09785],
[-3.64535, 2.16524, 2.21279, 0.09907],
[-3.56233, 1.96321, 1.91484, 0.11407],
[-3.46272, 1.77021, 1.91484, 0.11342],
[-3.34724, 1.57801, 1.91484, 0.1171],
[-3.24157, 1.38105, 1.91484, 0.11673],
[-3.15504, 1.1752, 1.91484, 0.11661],
[-3.09776, 0.9569, 1.91484, 0.11786],
[-3.08298, 0.72316, 2.27771, 0.10283],
[-3.1024, 0.47883, 2.58452, 0.09484],
[-3.15246, 0.2258, 3.01738, 0.08548],
[-3.22865, -0.03436, 3.70783, 0.07311],
[-3.32473, -0.30012, 3.75955, 0.07517],
[-3.43805, -0.58059, 2.93566, 0.10304],
[-3.546, -0.86322, 2.48631, 0.12168],
[-3.64553, -1.14905, 2.19274, 0.13803],
[-3.7334, -1.43891, 1.97964, 0.153],
[-3.80613, -1.73316, 1.81677, 0.16684],
[-3.85927, -2.03159, 1.68762, 0.17962],
[-3.87978, -2.33211, 1.57689, 0.19102],
[-3.85615, -2.62554, 1.48371, 0.19841],
[-3.78227, -2.89753, 1.40333, 0.20084],
[-3.65967, -3.13266, 1.40333, 0.18896],
[-3.49645, -3.31862, 1.40333, 0.17632],
[-3.30398, -3.44764, 1.40333, 0.16512],
[-3.09438, -3.51473, 1.40333, 0.15682],
[-2.88048, -3.5158, 1.40333, 0.15243],
[-2.6779, -3.44609, 1.57641, 0.1359],
[-2.49625, -3.32139, 1.72646, 0.12762],
[-2.34124, -3.15005, 1.92392, 0.1201],
[-2.21599, -2.93972, 2.20724, 0.11091],
[-2.12037, -2.69858, 2.02637, 0.12801],
[-2.04981, -2.43574, 1.78172, 0.15275],
[-1.99508, -2.16083, 1.60383, 0.17477],
[-1.93263, -1.88489, 1.47009, 0.19245],
[-1.84975, -1.62521, 1.36168, 0.20018],
[-1.7377, -1.39302, 1.36168, 0.18934],
[-1.59372, -1.19856, 1.36168, 0.17769],
[-1.42019, -1.0509, 1.36168, 0.16733],
[-1.22334, -0.95879, 1.36168, 0.15961],
[-1.01343, -0.93121, 1.36168, 0.15548],
[-0.80729, -0.97786, 1.49994, 0.14091],
[-0.61965, -1.08431, 1.61331, 0.13372],
[-0.45969, -1.24165, 1.75187, 0.12808],
[-0.33377, -1.44167, 1.92991, 0.12247],
[-0.2455, -1.67602, 1.83366, 0.13657],
[-0.19492, -1.93596, 1.50247, 0.17625],
[-0.1775, -2.21285, 1.3, 0.21341],
[-0.18417, -2.49917, 1.3, 0.2203],
[-0.19965, -2.75653, 1.3, 0.19833],
[-0.18606, -2.99663, 1.3, 0.18498],
[-0.12847, -3.2071, 1.3, 0.16785],
[-0.02244, -3.37836, 1.3, 0.15495],
[0.13308, -3.49719, 1.38569, 0.14124],
[0.32489, -3.56319, 1.66601, 0.12176],
[0.5401, -3.58442, 1.96655, 0.10997],
[0.77185, -3.56568, 2.44337, 0.09516],
[1.01401, -3.51545, 2.86799, 0.08623],
[1.26577, -3.48745, 2.61789, 0.09676],
[1.51687, -3.48155, 2.16026, 0.11627],
[1.76715, -3.49571, 1.88052, 0.13331],
[2.01654, -3.52832, 1.6859, 0.14919],
[2.26497, -3.578, 1.54037, 0.16447],
[2.51115, -3.64316, 1.42374, 0.17886],
[2.75413, -3.67895, 1.42374, 0.1725],
[2.98477, -3.6764, 1.42374, 0.16201],
[3.19678, -3.63205, 1.42374, 0.15213],
[3.38448, -3.54454, 1.42374, 0.14546],
[3.54025, -3.41222, 1.42374, 0.14356],
[3.65044, -3.23239, 1.54768, 0.13627],
[3.71012, -3.01555, 1.64811, 0.13646],
[3.71045, -2.7706, 1.77053, 0.13835],
[3.64447, -2.51267, 1.92057, 0.13863],
[3.51551, -2.26434, 2.11174, 0.13251],
[3.33846, -2.04265, 2.37125, 0.11965],
[3.12819, -1.85029, 2.74516, 0.10381],
[2.89518, -1.68254, 3.3776, 0.085],
[2.64119, -1.52853, 3.60514, 0.08239],
[2.39845, -1.35687, 3.88144, 0.0766],
[2.16595, -1.17024, 4.0, 0.07453],
[1.94252, -0.97115, 4.0, 0.07482],
[1.72682, -0.76198, 4.0, 0.07512],
[1.51737, -0.54507, 4.0, 0.07538],
[1.31253, -0.32267, 4.0, 0.07559],
[1.11054, -0.09697, 4.0, 0.07572],
[0.9095, 0.12998, 4.0, 0.0758]]


def find_nearest_waypoint(car_x, car_y, heading):
    min_dist = float("inf")
    nearest_idx = 0
    
    for i, (wx, wy, _, _) in enumerate(WAYPOINTS):
        dist = math.sqrt((car_x - wx)**2 + (car_y - wy)**2)
        
        # 진행 방향 고려
        waypoint_heading = math.atan2(wy - car_y, wx - car_x)
        heading_diff = abs(waypoint_heading - math.radians(heading))
        
        # 진행 방향과 90도 이상 차이나면 제외
        if heading_diff > math.pi / 2:
            continue
        
        if dist < min_dist:
            min_dist = dist
            nearest_idx = i

    return nearest_idx

def is_radian(val):
    return 0 <= val <= 2 * math.pi


def reward_function(params):

    # 1) 우선 가장 기본적인 검증: 트랙 안에 있는지 여부
    if not params["all_wheels_on_track"]:
        return 1e-3  # 트랙 이탈 시 거의 0에 가까운 보상

    # 2) 기본 보상값 설정
    reward = 1.0

    # 3) 현재 상태 불러오기
    car_x = params["x"]
    car_y = params["y"]
    car_speed = params["speed"]
    car_steering = params["steering_angle"]
    car_heading = params["heading"]

    # 4) 가장 가까운 웨이포인트 찾기
    nearest_idx = find_nearest_waypoint(car_x, car_y, car_heading)
    waypoint_x, waypoint_y, target_speed, target_steering = WAYPOINTS[nearest_idx]
    
    # 5) 위치 오차(distance error) 계산
    distance_error = math.sqrt((car_x - waypoint_x)**2 + (car_y - waypoint_y)**2)

    # 6) 속도 오차(speed error) 계산
    speed_error = abs(car_speed - target_speed)

    # 7) 조향 오차(steering error) 계산
    #   주의: 보통 DeepRacer의 steering_angle 단위(도)와
    #         우리가 목표로 삼는 steering 값(도)가 같은지 확인해야 합니다.
    steering_error = abs(car_steering - math.degrees(target_steering)
                         if is_radian(target_steering) 
                         else abs(car_steering - target_steering))
    # 만약 target_steering이 이미 '도(deg)' 단위라면: 
    # steering_error = abs(car_steering - target_steering)

    # 8) 보상 계산 예시 (가중치/계수는 상황에 따라 조절)
    #    - 위치 오차가 작을수록 보상을 크게
    #    - 속도 오차가 작을수록 보상을 크게
    #    - 조향 오차가 작을수록 보상을 크게
    #    - (가중치 합이 너무 크지 않도록 조절)

    # distance_reward: 0 ~ 1 범위로 만들기 위한 간단 예시
    # distance가 0일 때 1, 멀어질수록 0에 가깝게
    # (distance_scale 조절로 민감도 조정)
    distance_scale = 2.0  
    distance_reward = max(0.0, 1 - distance_scale * distance_error)

    # speed_reward: target_speed와의 차이가 작으면 보상 높게
    # 오차가 0이면 1, 오차가 커지면 0에 가까워짐
    speed_scale = 1.0  
    speed_reward = max(0.0, 1 - speed_scale * (speed_error / target_speed 
                                               if target_speed != 0 else 0))

    # steering_reward: target_steering과의 차이가 작으면 보상 높게
    # 최대 조향각이 ±30도라 가정하면, 오차가 30도 이상이면 거의 0으로
    steering_scale = 1/30  
    steering_reward = max(0.0, 1 - steering_scale * steering_error)

    # 각각 곱 또는 가중합
    # 곱셈을 사용하면 어느 한 항이 0에 가까우면 전체가 낮아짐(모두 잘 맞출 때 높은 보상)
    # 가중합을 사용하면 개별 항목 기여도 합산(한 항목이 불량이어도 다른 항목으로 상쇄)
    # 필요에 따라 선택(아래는 곱셈 예시)
    reward *= (1.0
               + 1.0 * distance_reward
               + 0.5 * speed_reward
               + 0.5 * steering_reward
              )

    # 9) 추가 페널티/보상 예시
    # 트랙 중앙선에서 너무 멀면 페널티
    distance_from_center = params["distance_from_center"]
    track_width = params["track_width"]
    if distance_from_center >= 0.5 * track_width: 
        reward *= 0.8  # 중앙에서 너무 멀면 보상 감소
    
    return float(reward)
